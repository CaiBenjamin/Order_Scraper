name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  backend-tests:
    name: Backend Tests (Python)
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python 3.12
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        
    - name: Cache pip dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('backend/requirements.txt', 'backend/requirements-dev.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
        
    - name: Install dependencies
      working-directory: ./backend
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-dev.txt
        
    - name: Run pytest with coverage
      working-directory: ./backend
      run: |
        pytest --cov=scraper --cov-report=term --cov-report=xml
        
    - name: Upload coverage reports
      uses: codecov/codecov-action@v4
      with:
        file: ./backend/coverage.xml
        flags: backend
        fail_ci_if_error: false

  frontend-tests:
    name: Frontend Tests (Next.js)
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run linter
      run: npm run lint
      
    - name: Build Next.js app
      run: npm run build
      
    - name: Run tests (if any)
      run: npm test --if-present

  integration-test:
    name: Integration Test (End-to-End)
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        
    - name: Install Python dependencies
      working-directory: ./backend
      run: |
        pip install -r requirements.txt
        
    - name: Test email parser with fixtures
      working-directory: ./backend
      run: |
        python -c "
from scraper.imap_scraper import parse_costco_email

# Test confirmed order
result = parse_costco_email(
    'Your Costco.com Order Number 1261457232 is Confirmed',
    '<html><body>Test email</body></html>'
)
assert result is not None
assert result['order_number'] == '1261457232'
assert result['status'] == 'Confirmed'
print('✅ Parser test passed')
"

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Check for secrets in code
      run: |
        if grep -r "xuzo thvb" . --exclude-dir=.git --exclude-dir=node_modules 2>/dev/null; then
          echo "❌ Found hardcoded credentials in code!"
          exit 1
        fi
        echo "✅ No hardcoded credentials found"
        
    - name: Verify .env is gitignored
      run: |
        if git ls-files | grep -E "\.env$|backend/\.env$"; then
          echo "❌ .env file is tracked by git!"
          exit 1
        fi
        echo "✅ .env files are properly ignored"
